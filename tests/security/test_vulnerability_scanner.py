import json
import subprocess
import sys

import runpy

import pytest

from security import vulnerability_scanner


def test_run_bandit_success(monkeypatch):
    def fake_run(cmd, capture_output, text, check):
        assert "-iii" in cmd
        class Result:
            returncode = 0
            stdout = json.dumps({"results": []})
            stderr = ""
        return Result()

    monkeypatch.setattr(subprocess, "run", fake_run)
    report = vulnerability_scanner.run_bandit(full_scan=False)
    assert report == {"results": []}


def test_run_bandit_error(monkeypatch):
    def fake_run(cmd, capture_output, text, check):
        class Result:
            returncode = 2
            stdout = ""
            stderr = "boom"
        return Result()

    monkeypatch.setattr(subprocess, "run", fake_run)
    with pytest.raises(RuntimeError):
        vulnerability_scanner.run_bandit(full_scan=True)


def test_main_disabled(monkeypatch):
    monkeypatch.setenv("VULN_SCAN_ENABLED", "0")
    monkeypatch.setattr(sys, "argv", ["vscan"])
    assert vulnerability_scanner.main() == 0


def test_main_bandit_not_installed(monkeypatch):
    def fake_run_bandit(full_scan):
        raise FileNotFoundError
    monkeypatch.setattr(vulnerability_scanner, "run_bandit", fake_run_bandit)
    monkeypatch.setattr(sys, "argv", ["vscan"])
    assert vulnerability_scanner.main() == 1


def test_main_detects_high_severity(monkeypatch, tmp_path):
    def fake_run_bandit(full_scan):
        return {"results": [{"issue_severity": "HIGH"}]}

    monkeypatch.setattr(vulnerability_scanner, "run_bandit", fake_run_bandit)
    monkeypatch.setattr(vulnerability_scanner, "REPORT_PATH", tmp_path / "report.json")
    monkeypatch.setattr(sys, "argv", ["vscan"])
    assert vulnerability_scanner.main() == 1
    data = json.loads((tmp_path / "report.json").read_text())
    assert data["results"][0]["issue_severity"] == "HIGH"


def test_main_no_high_severity(monkeypatch, tmp_path):
    def fake_run_bandit(full_scan):
        return {"results": [{"issue_severity": "LOW"}]}

    monkeypatch.setattr(vulnerability_scanner, "run_bandit", fake_run_bandit)
    monkeypatch.setattr(vulnerability_scanner, "REPORT_PATH", tmp_path / "report.json")
    monkeypatch.setattr(sys, "argv", ["vscan"])
    assert vulnerability_scanner.main() == 0


def test_cli_entrypoint(monkeypatch, tmp_path):
    def fake_subprocess_run(cmd, capture_output, text, check):
        class Result:
            returncode = 0
            stdout = json.dumps({"results": []})
            stderr = ""
        return Result()

    monkeypatch.setattr(subprocess, "run", fake_subprocess_run)
    monkeypatch.setattr(vulnerability_scanner, "REPORT_PATH", tmp_path / "report.json")
    monkeypatch.setattr(sys, "argv", ["vscan"])
    with pytest.raises(SystemExit) as exc:
        runpy.run_module("security.vulnerability_scanner", run_name="__main__")
    assert exc.value.code == 0

