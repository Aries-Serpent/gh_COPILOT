import json
import os
import subprocess
import sys
from pathlib import Path

SCRIPT = Path("security/vulnerability_scanner.py")
REPORT = Path("reports/vulnerability_scan.json")


def _cleanup_report() -> None:
    if REPORT.exists():
        REPORT.unlink()
    if REPORT.parent.exists() and not any(REPORT.parent.iterdir()):
        REPORT.parent.rmdir()


def _create_bandit(tmp_path: Path, payload: str) -> dict[str, str]:
    bandit = tmp_path / "bandit"
    bandit.write_text(
        "#!/usr/bin/env python3\n"
        "import json,sys\n"
        f"json.dump({payload}, sys.stdout)\n"
    )
    bandit.chmod(0o755)
    return {"PATH": f"{tmp_path}:{os.environ['PATH']}"}


def _run(env: dict[str, str] | None = None, args: list[str] | None = None) -> subprocess.CompletedProcess:
    env_vars = os.environ.copy()
    if env:
        env_vars.update(env)
    cmd = [sys.executable, str(SCRIPT)] + (args or [])
    return subprocess.run(cmd, capture_output=True, text=True, env=env_vars)


def test_scan_disabled(tmp_path):
    _cleanup_report()
    env = {"VULN_SCAN_ENABLED": "0"}
    result = _run(env=env)
    assert result.returncode == 0
    assert not REPORT.exists()


def test_scan_detects_critical(tmp_path):
    _cleanup_report()
    env = {"VULN_SCAN_ENABLED": "1"}
    env.update(_create_bandit(tmp_path, '{"results":[{"issue_severity":"HIGH"}]}'))
    result = _run(env=env)
    assert result.returncode == 1
    assert REPORT.exists()
    data = json.loads(REPORT.read_text())
    assert data["results"][0]["issue_severity"] == "HIGH"
    _cleanup_report()


def test_scan_without_critical(tmp_path):
    _cleanup_report()
    env = {"VULN_SCAN_ENABLED": "1"}
    env.update(_create_bandit(tmp_path, '{"results":[{"issue_severity":"LOW"}]}'))
    result = _run(env=env)
    assert result.returncode == 0
    assert REPORT.exists()
    data = json.loads(REPORT.read_text())
    assert data["results"][0]["issue_severity"] == "LOW"
    _cleanup_report()
