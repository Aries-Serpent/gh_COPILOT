<!doctype html>
<html>
<head>
    <title>Compliance Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='main.js') }}"></script>
    <script src="{{ url_for('static', filename='chart.min.js') }}"></script>
    <script src="{{ url_for('static', filename='placeholder_chart.js') }}"></script>
    <script src="{{ url_for('static', filename='js/corrections_ws.js') }}"></script>
    <script>
        let lintGauge, testGauge, placeholderGauge;
        function initGauges(){
            const base = {
                type: 'doughnut',
                data: {
                    labels: ['score', 'rest'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['#2e86de', '#eee'],
                        borderWidth: 0,
                    }],
                },
                options: {
                    rotation: -Math.PI,
                    circumference: Math.PI,
                    cutout: '70%',
                    plugins: { legend: { display: false } },
                },
            };
            lintGauge = new Chart(document.getElementById('lintGauge'), JSON.parse(JSON.stringify(base)));
            testGauge = new Chart(document.getElementById('testGauge'), JSON.parse(JSON.stringify(base)));
            placeholderGauge = new Chart(document.getElementById('placeholderGauge'), JSON.parse(JSON.stringify(base)));
        }
        function updateGauge(chart, value){
            if(!chart) return;
            chart.data.datasets[0].data = [value, 100 - value];
            chart.update();
        }
        function applyAlert(id, level){
            const el = document.getElementById(id);
            if(!el) return;
            el.classList.remove('status-green','status-yellow','status-red');
            if(level === 'critical'){
                el.classList.add('status-red');
            }else if(level === 'warning'){
                el.classList.add('status-yellow');
            }else if(level){
                el.classList.add('status-green');
            }
        }
        function computeAlert(value, bounds){
            if(bounds && typeof bounds === 'object'){
                if(bounds.critical !== undefined && value < bounds.critical){
                    return 'critical';
                }
                if(bounds.warning !== undefined && value < bounds.warning){
                    return 'warning';
                }
            }
            return 'ok';
        }
        // Metrics sourced from /api/compliance_scores (analytics.db)
        function updateMetrics(data){
        document.getElementById('placeholder_removal').textContent = data.placeholder_removal;
        document.getElementById('compliance_score').textContent = data.compliance_score.toFixed(3);
        if(data.composite_score !== undefined){
            document.getElementById('composite_score').textContent = data.composite_score.toFixed(2);
        }
            document.getElementById('ruff_issues').textContent = data.ruff_issues || 0;
            document.getElementById('tests_passed').textContent = data.tests_passed || 0;
            document.getElementById('tests_failed').textContent = data.tests_failed || 0;
        const ts = data.timestamp || new Date().toISOString();
        const lintEl = document.getElementById('lint_score');
        const testEl = document.getElementById('test_score');
        const placeholderEl = document.getElementById('placeholder_score');
        lintEl.textContent = (data.lint_score ?? 0).toFixed(2);
        testEl.textContent = (data.test_score ?? 0).toFixed(2);
        placeholderEl.textContent = (data.placeholder_score ?? 0).toFixed(2);
        lintEl.title = `Definition: percentage of files passing lint checks. Units: percent. Cadence: periodic. Last update: ${ts}`;
        testEl.title = `Definition: percentage of tests passing. Units: percent. Cadence: periodic. Last update: ${ts}`;
        placeholderEl.title = `Definition: progress removing placeholders. Units: percent. Cadence: periodic. Last update: ${ts}`;
        updateGauge(lintGauge, data.lint_score ?? 0);
        updateGauge(testGauge, data.test_score ?? 0);
        updateGauge(placeholderGauge, data.placeholder_score ?? 0);
        const comp = data.composite_score ?? data.compliance_score;
        const alert = document.getElementById('compliance_alert');
        alert.textContent = comp.toFixed(2);
        const thresholds = data.thresholds || {};
        applyAlert('lint_score', computeAlert(data.lint_score ?? 0, thresholds.lint_score));
        applyAlert('test_score', computeAlert(data.test_score ?? 0, thresholds.test_score));
        applyAlert('placeholder_score', computeAlert(data.placeholder_score ?? 0, thresholds.placeholder_score));
        const compBounds = thresholds.composite_score || thresholds.compliance_score;
        applyAlert('compliance_alert', computeAlert(comp, compBounds));
        document.getElementById('open_placeholders').textContent = data.open_placeholders || 0;
            document.getElementById('resolved_placeholders').textContent = data.resolved_placeholders || 0;
            const prog = data.progress !== undefined ? (data.progress * 100).toFixed(1) + '%' : '0%';
            document.getElementById('remediation_progress').textContent = prog;
            document.getElementById('lessons_integration_status').textContent = data.lessons_integration_status || 'UNKNOWN';
            document.getElementById('lessons_hook_coverage').textContent =
                data.lessons_hook_coverage !== undefined ? (data.lessons_hook_coverage * 100).toFixed(1) + '%' : '0%';
            document.getElementById('missing_lesson_hooks').textContent = (data.missing_lesson_hooks || []).join(', ') || 'none';
            document.getElementById('average_query_latency').textContent = (data.average_query_latency ?? 0).toFixed(3);
            document.getElementById('rollback_count').textContent = data.rollback_count || 0;
            document.getElementById('progress_status').textContent = data.progress_status || 'unknown';
            const pb = document.getElementById('placeholder_breakdown');
            pb.innerHTML = '';
            if (data.placeholder_breakdown){
                Object.entries(data.placeholder_breakdown).forEach(([type,count])=>{
                    const li = document.createElement('li');
                    li.textContent = type+': '+count;
                    pb.appendChild(li);
                });
            }
            const ct = document.getElementById('compliance_trend');
            ct.innerHTML = '';
            (data.compliance_trend || []).forEach(v => {
                const li = document.createElement('li');
                li.textContent = v;
                ct.appendChild(li);
            });
        }
        function updateRollbacks(logs){
            const list = document.getElementById('rollbacks');
            list.innerHTML = '';
            logs.forEach(r => {
                const li = document.createElement('li');
                li.textContent = r.timestamp + ' - ' + r.target + (r.backup ? ' ('+r.backup+')' : '');
                list.appendChild(li);
            });
        }
        function updateCorrections(logs){
            const list = document.getElementById('corrections');
            list.innerHTML = '';
            logs.forEach(c => {
                const li = document.createElement('li');
                li.textContent = c.timestamp + ' - ' + c.path + ' (' + c.status + ')';
                list.appendChild(li);
            });
        }
        function updateSyncEvents(events){
            const list = document.getElementById('sync_events');
            list.innerHTML = '';
            events.forEach(e => {
                const li = document.createElement('li');
                li.textContent = e.timestamp + ' - ' + e.source_db + ' -> ' + e.target_db + ' (' + e.action + ')';
                list.appendChild(li);
            });
        }
        function updateAuditResults(rows){
            const list = document.getElementById('audit_results');
            list.innerHTML = '';
            rows.forEach(r => {
                const li = document.createElement('li');
                li.textContent = r.placeholder_type + ': ' + r.count;
                list.appendChild(li);
            });
        }
        function updateCompliance(payload){
            if(payload.metrics){
                updateMetrics(payload.metrics);
            }
            if(payload.rollbacks){
                updateRollbacks(payload.rollbacks);
            }
            if(payload.placeholders_open !== undefined){
                document.getElementById('compliance_open_placeholders').textContent = payload.placeholders_open;
            }
            if(payload.last_resolved !== undefined){
                document.getElementById('compliance_last_resolved').textContent = payload.last_resolved;
            }
            if(payload.audit_log){
                const list = document.getElementById('audit_log_entries');
                list.innerHTML = '';
                payload.audit_log.forEach(e => {
                    const li = document.createElement('li');
                    li.textContent = e.ts + ' - ' + e.summary;
                    list.appendChild(li);
                });
            }
        }
        function loadComplianceChart(){
            fetch('/api/compliance_scores').then(r=>r.json()).then(data => {
                updateComplianceChart(data.scores || []);
            }).catch(err => console.log('Failed to load compliance scores:', err));
        }
        function updateComplianceChart(scores){
            const ctx = document.getElementById('complianceChart').getContext('2d');
            const labels = scores.map(s => new Date(s.timestamp * 1000).toLocaleDateString()).slice(-20);
            const data = scores.map(s => s.composite).slice(-20);
            
            if(window.complianceChart) {
                window.complianceChart.destroy();
            }
            
            window.complianceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Composite Compliance Score',
                        data: data,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderWidth: 2,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Score (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Compliance Score Trend (Last 20 Data Points)'
                        }
                    }
                }
            });
        }
        function loadMetricsTrend(){
            fetch('/metrics/trend').then(r=>r.json()).then(d=>{
                const ctx = document.getElementById('metricsTrend').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: d.timestamps,
                        datasets: [{
                            data: d.metrics,
                            borderColor: '#e74c3c',
                            fill: false,
                            tension: 0.3,
                        }],
                    },
                    options: {
                        plugins: { legend: { display: false } },
                        scales: { x: { display: false }, y: { display: false } },
                        elements: { point: { radius: 0 } },
                    },
                });
            });
        }
        function pollCompliance(){
            fetch('/dashboard/compliance')
                .then(r=>r.json())
                .then(updateCompliance)
                .catch(err => console.error('Failed to load compliance data', err));
        }
        function pollExtras(){
            fetch('/sync_events').then(r=>r.json()).then(updateSyncEvents);
            fetch('/audit_results').then(r=>r.json()).then(updateAuditResults);
        }
        window.onload = function(){
            initGauges();
            if(!!window.EventSource){
                const es = new EventSource('/metrics_stream');
                es.onmessage = function(evt){
                    const payload = JSON.parse(evt.data);
                    updateMetrics(payload);
                    if(window.updatePlaceholderChart){
                        window.updatePlaceholderChart(payload.placeholder_history || []);
                    }
                };
                const cs = new EventSource('/corrections_stream');
                cs.onmessage = function(evt){
                    updateCorrections(JSON.parse(evt.data));
                };
            }else{
                setInterval(function(){
                    fetch('/metrics').then(r=>r.json()).then(payload => {
                        updateMetrics(payload.metrics);
                        if(window.updatePlaceholderChart){
                            window.updatePlaceholderChart(payload.placeholder_history || []);
                        }
                    });
                },5000);
                setInterval(function(){
                    fetch('/corrections').then(r=>r.json()).then(updateCorrections);
                },5000);
            }
            pollCompliance();
            pollExtras();
            loadComplianceChart();
            loadMetricsTrend();
            setInterval(pollCompliance,5000);
            setInterval(pollExtras,5000);
            setInterval(loadComplianceChart,30000); // Update chart every 30 seconds
            setInterval(loadMetricsTrend,30000);
        };
    </script>
</head>
<body>
<h1>Compliance Dashboard</h1>
    <nav>
        <a href="/corrections/view">Corrections</a>
    <a href="/api/compliance_scores">Compliance</a>
    <a href="/rollbacks">Rollbacks</a>
    </nav>
<div>
    <strong>Placeholder Removals:</strong> <span id="placeholder_removal">{{ metrics.placeholder_removal | default(0) }}</span><br>
    <strong>Compliance Score:</strong> <span id="compliance_score">{{ metrics.compliance_score | default(0) }}</span><br>
    <strong>Composite Score:</strong> <span id="composite_score">{{ metrics.composite_score | default(0) }}</span><br>
    <strong>Lint Issues:</strong> <span id="ruff_issues">{{ metrics.ruff_issues | default(0) }}</span><br>
    <strong>Tests Passed:</strong> <span id="tests_passed">{{ metrics.tests_passed | default(0) }}</span><br>
    <strong>Tests Failed:</strong> <span id="tests_failed">{{ metrics.tests_failed | default(0) }}</span><br>
    <strong title="Percentage of files passing ruff checks">Lint Score:</strong> <span id="lint_score">{{ metrics.lint_score | default(0) }}</span><br>
    <strong title="Percentage of tests passing">Test Score:</strong> <span id="test_score">{{ metrics.test_score | default(0) }}</span><br>
    <strong title="Progress removing TODO/FIXME placeholders">Placeholder Score:</strong> <span id="placeholder_score">{{ metrics.placeholder_score | default(0) }}</span><br>
    <div id="score_gauges">
        <!-- Gauges support click drill-down via main.js -->
        <canvas id="lintGauge" class="gauge" data-metric="lint_score" title="Lint score gauge"></canvas>
        <canvas id="testGauge" class="gauge" data-metric="test_score" title="Test score gauge"></canvas>
        <canvas id="placeholderGauge" class="gauge" data-metric="placeholder_score" title="Placeholder score gauge"></canvas>
    </div>
    <!-- Details panel populated when a gauge is clicked -->
    <div id="metric-details" class="metric-details" hidden></div>
    <div class="exports">
        <a href="/api/compliance_scores" id="export-json">Download JSON</a> |
        <a href="/api/compliance_scores.csv" id="export-csv">Download CSV</a>
    </div>
    <div>Composite Alert: <span id="compliance_alert" class="status-indicator">--</span></div>
    <strong>Open Placeholders:</strong> <span id="open_placeholders">{{ metrics.open_placeholders | default(0) }}</span><br>
    <strong>Resolved Placeholders:</strong> <span id="resolved_placeholders">{{ metrics.resolved_placeholders | default(0) }}</span><br>
    <strong>Remediation Progress:</strong> <span id="remediation_progress">{{ ((metrics.progress or 0) * 100) | round(1) }}%</span><br>
    <strong>Lessons Integration Status:</strong> <span id="lessons_integration_status">UNKNOWN</span><br>
    <strong>Lessons Hook Coverage:</strong> <span id="lessons_hook_coverage">0%</span><br>
    <strong>Missing Lesson Hooks:</strong> <span id="missing_lesson_hooks">none</span><br>
    <strong>Average Query Latency (ms):</strong> <span id="average_query_latency">0</span><br>
    <strong>Rollback Count:</strong> <span id="rollback_count">0</span><br>
    <strong>Progress Status:</strong> <span id="progress_status">unknown</span>
    <h3>Placeholder Types</h3>
    <ul id="placeholder_breakdown"></ul>
    <h3>Compliance Trend</h3>
    <ul id="compliance_trend"></ul>
    <h3>Metrics Trend</h3>
    <canvas id="metricsTrend" width="100" height="30"></canvas>
    <h3>Placeholder History</h3>
    <div>
        Open: <span id="placeholderOpenCount">0</span>
        Resolved: <span id="placeholderResolvedCount">0</span>
    </div>
    <canvas id="placeholderChart"></canvas>
    <h3>Unresolved Placeholders</h3>
    <table id="unresolvedTable">
        <thead><tr><th>File</th><th>Line</th><th>Type</th></tr></thead>
        <tbody id="unresolvedBody"></tbody>
    </table>

    <h3>Compliance Score Trend</h3>
    <canvas id="complianceChart" width="800" height="300"></canvas>
</div>
<h2>Recent Corrections</h2>
<ul id="corrections">
{% for corr in corrections %}
    <li>{{ corr.timestamp }} - {{ corr.path }} ({{ corr.status }})</li>
{% endfor %}
</ul>

<h2>Open Placeholders</h2>
<div id="compliance_open_placeholders">{{ compliance.placeholders_open }}</div>
<div>Last resolved: <span id="compliance_last_resolved">{{ compliance.last_resolved }}</span></div>

<h2>Recent Audit Events</h2>
<ul id="audit_log_entries">
{% for entry in compliance.audit_log %}
    <li>{{ entry.ts }} - {{ entry.summary }}</li>
{% endfor %}
</ul>

<h2>Recent Rollbacks</h2>
<ul id="rollbacks">
{% for log in rollbacks %}
    <li>{{ log.timestamp }} - {{ log.target }}{% if log.backup %} ({{ log.backup }}){% endif %}</li>
{% endfor %}
</ul>

<h2>Recent Sync Events</h2>
<ul id="sync_events">
{% for event in sync_events %}
    <li>{{ event.timestamp }} - {{ event.source_db }} -> {{ event.target_db }} ({{ event.action }})</li>
{% endfor %}
</ul>

<h2>Anomaly Metrics</h2>
<div>Threshold: <span id="anomaly_threshold">{{ anomaly.threshold }}</span></div>
<div>Detected: <span id="anomaly_count">{{ anomaly.count }}</span></div>

<h2>Session Lifecycle</h2>
<div>Total Sessions: <span id="session_count">{{ lifecycle.count }}</span></div>
<div>Average Duration: <span id="avg_duration">{{ lifecycle.avg_duration }}</span></div>
<div>Success Rate: <span id="success_rate">{{ lifecycle.success_rate }}</span></div>
<div>Last Duration: <span id="last_duration">{{ lifecycle.last_duration }}</span></div>
<div>Last Status: <span id="last_status">{{ lifecycle.last_status }}</span></div>
<div>Last Zero-Byte Files: <span id="last_zero_byte">{{ lifecycle.last_zero_byte_violations }}</span></div>

<h2>Audit Results</h2>
<ul id="audit_results">
{% for row in audit_results %}
    <li>{{ row.placeholder_type }}: {{ row.count }}</li>
{% endfor %}
</ul>
{% include 'footer.html' %}
</body>
</html>
