<!doctype html>
<html>
<head>
    <title>Compliance Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='main.js') }}"></script>
    <script>
        function updateMetrics(data){
            document.getElementById('placeholder_removal').textContent = data.placeholder_removal;
            document.getElementById('compliance_score').textContent = data.compliance_score.toFixed(3);
            document.getElementById('lessons_integration_status').textContent = data.lessons_integration_status || 'UNKNOWN';
            document.getElementById('lessons_hook_coverage').textContent =
                data.lessons_hook_coverage !== undefined ? (data.lessons_hook_coverage * 100).toFixed(1) + '%' : '0%';
            document.getElementById('missing_lesson_hooks').textContent = (data.missing_lesson_hooks || []).join(', ') || 'none';
            document.getElementById('average_query_latency').textContent = (data.average_query_latency ?? 0).toFixed(3);
            document.getElementById('rollback_count').textContent = data.rollback_count || 0;
            document.getElementById('progress_status').textContent = data.progress_status || 'unknown';
            const pb = document.getElementById('placeholder_breakdown');
            pb.innerHTML = '';
            if (data.placeholder_breakdown){
                Object.entries(data.placeholder_breakdown).forEach(([type,count])=>{
                    const li = document.createElement('li');
                    li.textContent = type+': '+count;
                    pb.appendChild(li);
                });
            }
            const ct = document.getElementById('compliance_trend');
            ct.innerHTML = '';
            (data.compliance_trend || []).forEach(v => {
                const li = document.createElement('li');
                li.textContent = v;
                ct.appendChild(li);
            });
        }
        function updateRollbacks(logs){
            const list = document.getElementById('rollbacks');
            list.innerHTML = '';
            logs.forEach(r => {
                const li = document.createElement('li');
                li.textContent = r.timestamp + ' - ' + r.target + (r.backup ? ' ('+r.backup+')' : '');
                list.appendChild(li);
            });
        }
        function updateCompliance(payload){
            if(payload.metrics){
                updateMetrics(payload.metrics);
            }
            if(payload.rollbacks){
                updateRollbacks(payload.rollbacks);
            }
        }
        function pollCompliance(){
            fetch('/dashboard/compliance').then(r=>r.json()).then(updateCompliance);
        }
        window.onload = function(){
            if(!!window.EventSource){
                const es = new EventSource('/metrics_stream');
                es.onmessage = function(evt){
                    updateMetrics(JSON.parse(evt.data));
                };
            }else{
                setInterval(function(){
                    fetch('/metrics').then(r=>r.json()).then(updateMetrics);
                },5000);
            }
            pollCompliance();
            setInterval(pollCompliance,5000);
        };
    </script>
</head>
<body>
<h1>Compliance Dashboard</h1>
<div>
    <strong>Placeholder Removals:</strong> <span id="placeholder_removal">{{ metrics.placeholder_removal | default(0) }}</span><br>
    <strong>Compliance Score:</strong> <span id="compliance_score">{{ metrics.compliance_score | default(0) }}</span><br>
    <strong>Lessons Integration Status:</strong> <span id="lessons_integration_status">UNKNOWN</span><br>
    <strong>Lessons Hook Coverage:</strong> <span id="lessons_hook_coverage">0%</span><br>
    <strong>Missing Lesson Hooks:</strong> <span id="missing_lesson_hooks">none</span><br>
    <strong>Average Query Latency (ms):</strong> <span id="average_query_latency">0</span><br>
    <strong>Rollback Count:</strong> <span id="rollback_count">0</span><br>
    <strong>Progress Status:</strong> <span id="progress_status">unknown</span>
    <h3>Placeholder Types</h3>
    <ul id="placeholder_breakdown"></ul>
    <h3>Compliance Trend</h3>
    <ul id="compliance_trend"></ul>
</div>
<h2>Recent Rollbacks</h2>
<ul id="rollbacks">
{% for log in rollbacks %}
    <li>{{ log.timestamp }} - {{ log.target }}{% if log.backup %} ({{ log.backup }}){% endif %}</li>
{% endfor %}
</ul>
</body>
</html>
