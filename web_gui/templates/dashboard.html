<!doctype html>
<title>Compliance Dashboard</title>
<h1>Compliance Dashboard</h1>
<div id="progress">Loading...</div>
<div>
    <strong>Placeholder Removals:</strong> <span id="placeholder_removal">{{ metrics.placeholder_removal or 0 }}</span><br>
    <strong>Open Placeholders:</strong> <span id="open_placeholders">{{ metrics.open_placeholders or 0 }}</span><br>
    <strong>Compliance Score:</strong> <span id="compliance_score">{{ '%.3f'|format(metrics.compliance_score or 0) }}</span><br>
    <h3>Placeholder Types</h3>
    <ul id="placeholder_breakdown"></ul>
    <h3>Compliance Trend</h3>
    <canvas id="trendChart" width="400" height="150"></canvas>
    <span id="compliance_trend">
        {% for score in metrics.compliance_trend or [] %}
            {{ score }}{% if not loop.last %}, {% endif %}
        {% endfor %}
    </span>
    <button id="toggleUpdates">Pause</button>
</div>
<h2>Violations</h2>
<ul id="violations">
    {% for v in (alerts.violations if alerts is defined else []) %}
        <li>{{ v.timestamp }} - {{ v.details }}</li>
    {% endfor %}
</ul>
<h2>Rollbacks</h2>
<ul id="rollbacks"></ul>
<h2>Rollback History</h2>
<ul id="rollback_history"></ul>
<p><a href="/dashboard/compliance">Compliance Metrics</a></p>
<script>
function updateMetrics(data){
    document.getElementById('placeholder_removal').textContent = data.placeholder_removal;
    document.getElementById('open_placeholders').textContent = data.open_placeholders;
    document.getElementById('compliance_score').textContent = data.compliance_score.toFixed(3);
    const pb = document.getElementById('placeholder_breakdown');
    pb.innerHTML = '';
    if(data.placeholder_breakdown){
        Object.entries(data.placeholder_breakdown).forEach(([type,count])=>{
            const li = document.createElement('li');
            li.textContent = type+': '+count;
            pb.appendChild(li);
        });
    }
    const trend = data.compliance_trend || [];
    document.getElementById('compliance_trend').textContent = trend.join(', ');
    drawTrend(trend);
}
function updateAlerts(data){
    const v = document.getElementById('violations');
    v.innerHTML = '';
    data.violations.forEach(a => {
        const li = document.createElement('li');
        li.textContent = a.timestamp + ' - ' + a.details;
        v.appendChild(li);
    });
    const r = document.getElementById('rollbacks');
    r.innerHTML = '';
    data.rollbacks.forEach(a => {
        const li = document.createElement('li');
        li.textContent = a.timestamp + ' - ' + a.target + (a.backup ? '(' + a.backup + ')' : '');
        r.appendChild(li);
    });
}
function loadRollbackHistory(){
    fetch('/rollback_history').then(r=>r.json()).then(data=>{
        const h = document.getElementById('rollback_history');
        h.innerHTML = '';
        data.forEach(a=>{
            const li = document.createElement('li');
            li.textContent = a.timestamp + ' - ' + a.target + (a.backup ? '(' + a.backup + ')' : '');
            h.appendChild(li);
        });
    });
}
window.onload = function(){
function drawTrend(trend){
    const canvas = document.getElementById('trendChart');
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(trend.length === 0){return;}
    const max = Math.max(...trend);
    const step = canvas.width / Math.max(1, trend.length - 1);
    ctx.beginPath();
    trend.forEach((v,i)=>{
        const x = i * step;
        const y = canvas.height - (v / max) * canvas.height;
        if(i===0){ctx.moveTo(x,y);} else {ctx.lineTo(x,y);} });
    ctx.stroke();
}
let esMetrics, esAlerts, pollTimer, alertTimer;
function startUpdates(){
    if(window.EventSource){
        esMetrics = new EventSource('/metrics_stream');
        esMetrics.onmessage = (evt)=>updateMetrics(JSON.parse(evt.data));
        esAlerts = new EventSource('/alerts_stream');
        esAlerts.onmessage = (evt)=>updateAlerts(JSON.parse(evt.data));
    } else {
        pollTimer = setInterval(()=>fetch('/metrics').then(r=>r.json()).then(updateMetrics),5000);
        alertTimer = setInterval(()=>fetch('/alerts').then(r=>r.json()).then(updateAlerts),5000);
    }
    loadRollbackHistory();
}
function stopUpdates(){
    if(esMetrics){esMetrics.close(); esMetrics=null;}
    if(esAlerts){esAlerts.close(); esAlerts=null;}
    if(pollTimer){clearInterval(pollTimer); pollTimer=null;}
    if(alertTimer){clearInterval(alertTimer); alertTimer=null;}
}
window.onload = function(){
    startUpdates();
    const btn = document.getElementById('toggleUpdates');
    btn.onclick = function(){
        if(esMetrics || pollTimer){
            stopUpdates();
            btn.textContent = 'Resume';
        } else {
            startUpdates();
            btn.textContent = 'Pause';
        }
    };
};
</script>
