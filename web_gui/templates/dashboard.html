<!doctype html>
<title>Compliance Dashboard</title>
<h1>Compliance Dashboard</h1>
<div id="progress">Loading...</div>
<div>
    <strong>Placeholder Removals:</strong> <span id="placeholder_removal">0</span><br>
    <strong>Open Placeholders:</strong> <span id="open_placeholders">0</span><br>
    <strong>Compliance Score:</strong> <span id="compliance_score">0.000</span><br>
    <h3>Placeholder Types</h3>
    <ul id="placeholder_breakdown"></ul>
    <h3>Compliance Trend</h3>
    <span id="compliance_trend"></span>
</div>
<h2>Violations</h2>
<ul id="violations"></ul>
<h2>Rollbacks</h2>
<ul id="rollbacks"></ul>
<p><a href="/dashboard/compliance">Compliance Metrics</a></p>
<script>
function updateMetrics(data){
    document.getElementById('placeholder_removal').textContent = data.placeholder_removal;
    document.getElementById('open_placeholders').textContent = data.open_placeholders;
    document.getElementById('compliance_score').textContent = data.compliance_score.toFixed(3);
    const pb = document.getElementById('placeholder_breakdown');
    pb.innerHTML = '';
    if(data.placeholder_breakdown){
        Object.entries(data.placeholder_breakdown).forEach(([type,count])=>{
            const li = document.createElement('li');
            li.textContent = type+': '+count;
            pb.appendChild(li);
        });
    }
    document.getElementById('compliance_trend').textContent = (data.compliance_trend||[]).join(', ');
}
function updateAlerts(data){
    const v = document.getElementById('violations');
    v.innerHTML = '';
    data.violations.forEach(a => {
        const li = document.createElement('li');
        li.textContent = a.timestamp + ' - ' + a.details;
        v.appendChild(li);
    });
    const r = document.getElementById('rollbacks');
    r.innerHTML = '';
    data.rollbacks.forEach(a => {
        const li = document.createElement('li');
        li.textContent = a.timestamp + ' - ' + a.target + (a.backup ? '(' + a.backup + ')' : '');
        r.appendChild(li);
    });
}
window.onload = function(){
    if(window.EventSource){
        const esMetrics = new EventSource('/metrics_stream');
        esMetrics.addEventListener('message', (evt) => {
            const metrics = JSON.parse(evt.data);
            updateMetrics(metrics);
        });
        const esAlerts = new EventSource('/alerts_stream');
        esAlerts.addEventListener('message', (evt) => {
            const alerts = JSON.parse(evt.data);
            updateAlerts(alerts);
        });
    } else {
        setInterval(function(){
            fetch('/metrics').then(r => r.json()).then(updateMetrics);
            fetch('/alerts').then(r => r.json()).then(updateAlerts);
        }, 5000);
    }
};
</script>
