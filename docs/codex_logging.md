# Codex Logging

This document describes how Codex sessions record activity in the repository.

## Database schema

Codex events are stored in `databases/codex_log.db`, an SQLite database with two
tables:

- `codex_actions`
  - `id` – integer primary key
  - `session_id` – identifier for the Codex session
  - `ts` – ISO 8601 UTC timestamp when the action was recorded
  - `action` – name of the action
  - `statement` – free‑form details about the action
  - `metadata` – optional metadata stored as JSON text
- `codex_log`
  - `session_id` – identifier for the Codex session
  - `event` – `start` or `end`
  - `summary` – optional session summary text
  - `ts` – ISO 8601 UTC timestamp when the event was recorded

## Usage

Utilities in `utils/codex_log_db.py` manage the database:

```python
from utils.codex_log_db import (
    init_codex_log_db,
    record_codex_action,
    finalize_codex_log_db,
)

init_codex_log_db()
record_codex_action(session_id, "generate", "created script", metadata={"foo": 1})
finalize_codex_log_db()
```

The module automatically creates `codex_log.db` if it does not exist and
`finalize_codex_log_db()` copies it to `codex_session_logs.db` while staging both
files with `git add`.

### NDJSON metrics (local stream)

For lightweight, append-only metrics, use the NDJSON helper:

```python
from gh_copilot.automation.logging import append_ndjson
append_ndjson('.codex/action_log.ndjson', {'event': 'demo', 'ok': True})
```

Optional rotation (off by default): set `NDJSON_MAX_BYTES` to a positive integer to
rotate the file to `<path>.1` when it reaches the threshold.

### Helper script

For a simplified workflow, `scripts/DEDICATED_CODEX_LOG_DATABASE_TASKS.py` wraps
these utilities:

```python
from scripts.DEDICATED_CODEX_LOG_DATABASE_TASKS import (
    finalize_session,
    initialize_session,
    log_action,
)

initialize_session(session_id)
log_action(session_id, "generate", "created script")
finalize_session(session_id, "session complete")
```

### Context manager

Use :class:`utils.codex_log_db.CodexSessionLogger` to automatically manage the
start and end of a Codex session:

```python
from utils.codex_log_db import CodexSessionLogger

with CodexSessionLogger(session_id) as logger:
    logger.log("generate", "created script")
```

### Environment variables

`GH_COPILOT_WORKSPACE` must point to the repository root so the utility can
resolve the `databases/` directory. Set `GH_COPILOT_BACKUP_ROOT` to an external
path for any backups generated by the session tooling. Use `SESSION_ID_SOURCE`
to supply a custom session identifier; when unset, a UUID is generated. Set
`TEST_MODE=1` to prevent writes during test runs.

At the end of a session, call `finalize_codex_log_db()` to copy the log to
`databases/codex_session_logs.db` for archival and commit purposes:

```python
from utils.codex_log_db import finalize_codex_log_db

finalize_codex_log_db()
```

## Commit process

The log database is tracked with Git LFS. Set `ALLOW_AUTOLFS=1` and run
`git lfs install` once per environment. After logging a session, include the
updated database in commits:

```bash
git add databases/codex_log.db
git add databases/codex_session_logs.db
```

Run `git lfs status` or `git lfs ls-files codex_log.db` to verify the file is
managed by LFS before committing. The `.gitattributes` file already tracks
`*.db` files, so no additional configuration is typically required.

For a broader overview of session management and how Codex logging fits in,
see the [Session Management](../README.md#session-management) section of the
README.
