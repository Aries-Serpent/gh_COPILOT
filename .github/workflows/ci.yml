name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  lint-test:
    runs-on: ubuntu-latest
    env:
      FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY || 'test_secret' }}
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt', 'requirements-test.txt') }}

      - name: Setup project
        run: bash setup.sh

      - name: Activate virtualenv
        run: |
          echo "VIRTUAL_ENV=${{ github.workspace }}/.venv" >> $GITHUB_ENV
          echo "PATH=${{ github.workspace }}/.venv/bin:$PATH" >> $GITHUB_ENV

      - name: Lint
        run: make lint

      - name: Import template_engine modules
        run: |
          python - <<'PY'
          import importlib
          modules = [
              "template_engine.auto_generator",
              "template_engine.db_first_code_generator",
              "template_engine.log_utils",
              "template_engine.objective_similarity_scorer",
              "template_engine.pattern_clustering_sync",
              "template_engine.pattern_mining_engine",
              "template_engine.placeholder_utils",
              "template_engine.template_placeholder_remover",
              "template_engine.template_synchronizer",
              "template_engine.workflow_enhancer",
          ]
          for m in modules:
              importlib.import_module(m)
          PY

      - name: Lint source
        run: |
          pip install flake8 bandit
          flake8 --config=.flake8 . --count --show-source --statistics
          bandit -r src -ll

      - name: Check for zero-byte files
        run: bash scripts/check_zero_logs.sh .

      - name: Import template_engine
        run: |
          python - <<'PY'
          import template_engine.auto_generator
          import template_engine.template_synchronizer
          PY

      - name: Run tests with coverage
        run: |
          mkdir -p artifacts
          coverage run -m pytest -q tests tests/documentation tests/quantum --junitxml=artifacts/test-results.xml
          coverage xml -o artifacts/coverage.xml

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: artifacts
          path: artifacts

      - name: Verify template_engine import
        run: python -c "import template_engine"

  docker-build:
    needs: lint-test
    runs-on: ubuntu-latest
    env:
      FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY || 'test_secret' }}
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Build Docker image
        run: docker build -t gh_copilot .

      - name: Get Trivy version
        id: trivy-version
        run: echo "version=$(trivy --version | awk '{print $3}')" >> $GITHUB_ENV

      - name: Cache Trivy database
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements.txt', 'requirements-test.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Run tests in container
        run: |
          mkdir -p artifacts
          docker run --rm \
            -e GH_COPILOT_BACKUP_ROOT=/tmp/backups \
            -e FLASK_SECRET_KEY=$FLASK_SECRET_KEY \
            -v ${{ github.workspace }}/artifacts:/app/artifacts \
            gh_copilot coverage run -m pytest -q tests --junitxml=/app/artifacts/test-results.xml
          docker run --rm \
            -e GH_COPILOT_BACKUP_ROOT=/tmp/backups \
            -e FLASK_SECRET_KEY=$FLASK_SECRET_KEY \
            -v ${{ github.workspace }}/artifacts:/app/artifacts \
            gh_copilot coverage xml -o /app/artifacts/coverage.xml

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: artifacts
          path: artifacts

  codeql:
    runs-on: ubuntu-latest
    env:
      FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY || 'test_secret' }}
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v3
      - uses: github/codeql-action/init@v3
        with:
          languages: python
      - uses: github/codeql-action/analyze@v3
        with:
          output: codeql-results
      - name: Upload CodeQL results
        uses: actions/upload-artifact@v3
        with:
          name: codeql-results
          path: codeql-results
