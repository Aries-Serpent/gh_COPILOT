name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  Lint-and-Test:
    runs-on: ubuntu-latest
    env:
      GH_COPILOT_WORKSPACE: ${{ github.workspace }}
      GH_COPILOT_BACKUP_ROOT: /tmp/gh_copilot_backup
    strategy:
      matrix:
        python-version: ['3.8', '3.11']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate docker-compose config
        run: docker compose -f docker-compose.yml config

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt', 'requirements-test.txt') }}

      - name: Setup project
        run: bash setup.sh

      - name: Activate virtualenv
        run: |
          echo "VIRTUAL_ENV=${{ github.workspace }}/.venv" >> $GITHUB_ENV
          echo "PATH=${{ github.workspace }}/.venv/bin:$PATH" >> $GITHUB_ENV

      - name: Ruff lint
        run: |
          ruff check . --exit-zero
          ruff format --check .

      - name: Import template_engine modules
        run: |
          python - <<'PY'
          import importlib
          modules = [
              "template_engine.auto_generator",
              "template_engine.db_first_code_generator",
              "template_engine.log_utils",
              "template_engine.objective_similarity_scorer",
              "template_engine.pattern_clustering_sync",
              "template_engine.pattern_mining_engine",
              "template_engine.placeholder_utils",
              "template_engine.template_placeholder_remover",
              "template_engine.template_synchronizer",
              "template_engine.workflow_enhancer",
          ]
          for m in modules:
              importlib.import_module(m)
          PY

      - name: Lint source
        run: |
          pip install flake8 bandit
          flake8 --config=.flake8 . --count --show-source --statistics
          bandit -r src -ll

      - name: Check for zero-byte files
        run: bash scripts/check_zero_logs.sh .

      - name: Import template_engine
        run: |
          python - <<'PY'
          import template_engine.auto_generator
          import template_engine.template_synchronizer
          PY

      - name: Run tests
        run: make test

      - name: Upload test reports
        uses: actions/upload-artifact@v3
        with:
          name: test-logs
          path: tests/test_results

      - name: Verify template_engine import
        run: python -c "import template_engine"

  docker-build:
    needs: lint-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t gh_copilot .

      - name: Get Trivy version
        id: trivy-version
        run: echo "version=$(trivy --version | awk '{print $3}')" >> $GITHUB_ENV

      - name: Cache Trivy database
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements.txt', 'requirements-test.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-test.txt

      - name: Lint
        run: ruff check .

      - name: Test
        run: pytest -q
