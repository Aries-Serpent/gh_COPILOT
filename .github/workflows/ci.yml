name: CI
on:
  push:
    branches: ["**"]
  pull_request:
    branches: [main]
jobs:
  lfs-archive-guard:
    uses: ./.github/workflows/lfs-zip-guard.yml

  lint-test:
    needs: lfs-archive-guard
    runs-on: ubuntu-latest
    env:
      FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY || 'test_secret' }}
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0
      - run: git lfs checkout
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt', 'requirements-test.txt') }}

      - name: Setup project
        run: bash setup.sh

      - name: Activate virtualenv
        run: |
          echo "VIRTUAL_ENV=${{ github.workspace }}/.venv" >> $GITHUB_ENV
          echo "PATH=${{ github.workspace }}/.venv/bin:$PATH" >> $GITHUB_ENV

      - name: Install dependencies
        run: pip install -r requirements.txt

      - uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install lint dependencies
        run: pip install flake8 ruff==0.12.8

      - name: Install Pyright
        run: npm install pyright

      - name: Verify Ruff version
        run: |
          test "$(ruff --version)" = "ruff ${RUFF_VERSION}"
        env:
          RUFF_VERSION: "0.12.8"

      - name: Get changed Python files
        id: changed
        uses: tj-actions/changed-files@v35
        with:
          files: |
            **/*.py

      - name: Run ruff
        run: |
          mkdir -p reports/lint
          ruff check --config pyproject.toml --force-exclude . | tee reports/lint/ruff.txt

      - name: Run flake8 on changed files
        if: steps.changed.outputs.added_modified != ''
        run: flake8 --config=.flake8 ${{ steps.changed.outputs.added_modified }}

      - name: Run pyright
        run: npx pyright

      - name: Run combined checks
        env:
          GH_COPILOT_WORKSPACE: ${{ github.workspace }}
          GH_COPILOT_BACKUP_ROOT: /tmp/gh_copilot_backup
        run: python scripts/run_checks.py

      - name: Import template_engine modules
        run: |
          python - <<'PY'
          import importlib
          modules = [
              "template_engine.auto_generator",
              "template_engine.db_first_code_generator",
              "template_engine.log_utils",
              "template_engine.objective_similarity_scorer",
              "template_engine.pattern_clustering_sync",
              "template_engine.pattern_mining_engine",
              "template_engine.placeholder_utils",
              "template_engine.template_placeholder_remover",
              "template_engine.template_synchronizer",
              "template_engine.workflow_enhancer",
          ]
          for m in modules:
              importlib.import_module(m)
          PY

    - name: Check for zero-byte files
      run: bash scripts/check_zero_logs.sh .

    - name: Scan repository TODOs
      run: ./scripts/rg_safe.sh TODO -g "*.py" --max-count 100 | head || true

    - name: Import template_engine
      run: |
        python - <<'PY'
        import template_engine.auto_generator
          import template_engine.template_synchronizer
          PY

      - name: Validate roadmap
        run: python scripts/validate_roadmap.py docs/continuous_improvement_roadmap.md

      - name: Placeholder audit
        env:
          GH_COPILOT_DISABLE_VALIDATION: "1"
        run: |
          python scripts/code_placeholder_audit.py --workspace-path . \
            --analytics-db databases/analytics.db \
            --production-db databases/production.db \
            --dashboard-dir dashboard/compliance \
            --simulate --fail-on-findings

      - name: Run tests with coverage
        run: |
          mkdir -p reports/coverage artifacts
          pytest --cov=. --cov-report=xml:reports/coverage/coverage.xml --cov-report=term -q --disable-warnings tests tests/documentation tests/monitoring_tests tests/quantum_tests --junitxml=artifacts/test-results.xml || true

      - name: Enforce test pass rate
        run: python scripts/enforce_test_pass_rate.py artifacts/test-results.xml 90

      - name: Check coverage delta
        run: |
          git fetch origin main --depth=1
          python scripts/coverage_delta.py reports/coverage/coverage.xml

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: artifacts
          path: |
            artifacts
            reports

      - name: Verify template_engine import
        run: python -c "import template_engine"

    docs-metrics:
      runs-on: ubuntu-latest
      env:
        GH_COPILOT_WORKSPACE: ${{ github.workspace }}
        GH_COPILOT_BACKUP_ROOT: /tmp/gh_copilot_backup
      steps:
        - uses: actions/checkout@v4
          with:
            lfs: true
            fetch-depth: 0
        - run: git lfs checkout
        - uses: actions/setup-python@v4
          with:
            python-version: '3.11'
        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt
        - name: Generate docs metrics
          run: python scripts/generate_docs_metrics.py
        - name: Validate docs metrics
          run: python scripts/validate_docs_metrics.py

  docker-build:
    needs: lint-test
    runs-on: ubuntu-latest
    env:
      FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY || 'test_secret' }}
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            lfs: true
            fetch-depth: 0
        - run: git lfs checkout
        - uses: actions/setup-python@v4
          with:
            python-version: ${{ matrix.python-version }}

      - name: Build Docker image
        run: docker build -t gh_copilot .

      - name: Get Trivy version
        id: trivy-version
        run: echo "version=$(trivy --version | awk '{print $3}')" >> $GITHUB_ENV

      - name: Cache Trivy database
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements.txt', 'requirements-test.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-

      - name: Run tests in container
        run: |
          mkdir -p artifacts
          docker run --rm \
            -e GH_COPILOT_BACKUP_ROOT=/tmp/backups \
            -e FLASK_SECRET_KEY=$FLASK_SECRET_KEY \
            -v ${{ github.workspace }}/artifacts:/app/artifacts \
            gh_copilot coverage run -m pytest -q --disable-warnings --maxfail=10 --exitfirst tests --junitxml=/app/artifacts/test-results.xml
          docker run --rm \
            -e GH_COPILOT_BACKUP_ROOT=/tmp/backups \
            -e FLASK_SECRET_KEY=$FLASK_SECRET_KEY \
            -v ${{ github.workspace }}/artifacts:/app/artifacts \
            gh_copilot coverage xml -o /app/artifacts/coverage.xml

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: artifacts
          path: artifacts

  optional-deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0
      - run: git lfs checkout
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Run setup with optional deps
        run: bash setup.sh --with-optional

  codeql:
    runs-on: ubuntu-latest
    env:
      FLASK_SECRET_KEY: ${{ secrets.FLASK_SECRET_KEY || 'test_secret' }}
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0
      - run: git lfs checkout
      - uses: github/codeql-action/init@v3
        with:
          languages: python
      - uses: github/codeql-action/analyze@v3
        with:
          output: codeql-results
      - name: Upload CodeQL results
        uses: actions/upload-artifact@v3
        with:
          name: codeql-results
          path: codeql-results

  backup-restore:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0
      - run: git lfs checkout
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run backup and restore drill
        env:
          GH_COPILOT_WORKSPACE: ${{ github.workspace }}
          GH_COPILOT_BACKUP_ROOT: /tmp/gh_copilot_backup
          ANALYTICS_DB: /tmp/analytics.db
        run: |
          python - <<'PY'
          from unified_disaster_recovery_system import schedule_backups, restore_backup
          import sqlite3, os
          backup = schedule_backups()
          assert restore_backup(backup)
          conn = sqlite3.connect(os.environ["ANALYTICS_DB"])
          cur = conn.cursor()
          cur.execute(
              "SELECT description FROM event_log WHERE description IN (?, ?)",
              ("backup_scheduled", "restore_success"),
          )
          rows = {r[0] for r in cur.fetchall()}
          assert "backup_scheduled" in rows
          assert "restore_success" in rows
          PY
