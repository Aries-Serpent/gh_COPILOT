name: LFS ZIP Guard

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  verify-lfs-zip:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0
      - run: git lfs checkout

      - name: Ensure Git LFS available
        shell: bash
        run: |
          set -euo pipefail
          if ! git lfs version >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y git-lfs
          fi
          git lfs install --skip-repo
      - run: git lfs checkout

      - name: Validate that ZIP files are tracked by LFS
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${GITHUB_BASE_REF:-}" ]]; then
            echo "No base ref; skipping ZIP LFS check."
            exit 0
          fi

          git fetch origin "$GITHUB_BASE_REF"
          BASE_SHA=$(git merge-base HEAD "origin/$GITHUB_BASE_REF")

          git diff --name-only "$BASE_SHA" HEAD > changed_files.txt
          grep -E '\.zip$' changed_files.txt > changed_zips.txt || true

          if [[ ! -s changed_zips.txt ]]; then
            echo "No ZIP files changed."
            exit 0
          fi

          bad=0
          > bad_zips.txt
          while IFS= read -r file; do
            attrs=$(git check-attr filter diff merge -- "$file")
            if ! grep -q 'filter: lfs' <<<"$attrs" || ! grep -q 'diff: lfs' <<<"$attrs" || ! grep -q 'merge: lfs' <<<"$attrs"; then
              echo "$file" >> bad_zips.txt
              bad=1
            fi
          done < changed_zips.txt

          if [[ $bad -eq 1 ]]; then
            echo "::error title=ZIP files not tracked by LFS::The following ZIP files are not tracked by Git LFS:";
            sed 's/^/ - /' bad_zips.txt
            echo ""
            echo "To fix:"
            echo "  git lfs track \"*.zip\""
            echo "  git add .gitattributes $(cat bad_zips.txt)"
            echo "  git rm --cached $(cat bad_zips.txt)"
            echo "  git add $(cat bad_zips.txt)"
            echo "  git commit -m \"Track ZIPs with Git LFS\""
            exit 1
          else
            echo "All changed ZIP files are properly tracked by LFS."
          fi

      - name: Optional â€” verify LFS pointers resolvable
        if: ${{ always() }}
        shell: bash
        run: |
          set -euo pipefail
          git lfs fsck
