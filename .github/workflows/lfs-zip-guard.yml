name: LFS Archive Guard

on:
  workflow_call:

jobs:
  verify-lfs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0
      - run: git lfs checkout

      - name: Enforce LFS for archive files
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin "$GITHUB_BASE_REF" --depth=1
          git diff --name-only --diff-filter=AM FETCH_HEAD...HEAD > changed_files.txt
          archives=$(grep -E '\\.(zip|jar|tar.*|7z|rar|apk|ipa|nupkg|cab|iso)$' changed_files.txt || true)
          if [[ -z "$archives" ]]; then
            echo "No archive files added or modified."
            exit 0
          fi
          missing_files=""
          while IFS= read -r file; do
            if ! git check-attr filter -- "$file" | grep -q 'filter: lfs'; then
              echo "::error file=$file::Archive file is not tracked by Git LFS"
              missing_files+="$file\n"
            fi
          done <<< "$archives"
          if [[ -n "$missing_files" ]]; then
            echo -e "The following archive files are not tracked by Git LFS:\n$missing_files"
            exit 1
          fi
          echo "All archive files are properly tracked by Git LFS."

