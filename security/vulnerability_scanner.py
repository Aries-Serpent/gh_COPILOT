#!/usr/bin/env python3
"""Run a vulnerability scan using Bandit.

The script invokes ``bandit`` via subprocess and saves the JSON output to
``reports/vulnerability_scan.json``. If any issues with ``HIGH`` severity are
found, the process exits with a non-zero status. Scanning can be disabled by
setting the ``VULN_SCAN_ENABLED`` environment variable to ``0``. The optional
``--full-scan`` flag enables a deeper scan by lowering Bandit's severity
threshold.
"""

from __future__ import annotations

import argparse
import hmac
import json
import os
import subprocess
from pathlib import Path
from typing import Any


REPORT_PATH = Path("reports/vulnerability_scan.json")


def run_bandit(full_scan: bool) -> dict[str, Any]:
    """Execute bandit and return the parsed JSON report."""

    cmd = ["bandit", "-r", ".", "-f", "json"]
    # ``-ll`` lowers the severity and confidence thresholds for a deeper scan.
    # The default mode focuses on medium and high severity issues.
    cmd.append("-ll" if full_scan else "-iii")

    result = subprocess.run(cmd, capture_output=True, text=True, check=False)
    if result.returncode not in (0, 1):
        raise RuntimeError(f"bandit failed with exit code {result.returncode}: {result.stderr}")

    return json.loads(result.stdout or "{}")


def main() -> int:
    parser = argparse.ArgumentParser(description="Run vulnerability scan via Bandit.")
    parser.add_argument("--full-scan", action="store_true", help="enable deep scanning")
    args = parser.parse_args()

    if os.getenv("VULN_SCAN_ENABLED", "1") != "1":
        print("Vulnerability scanning disabled via VULN_SCAN_ENABLED.")
        return 0

    try:
        report = run_bandit(args.full_scan)
    except FileNotFoundError:
        print("bandit is not installed or not found in PATH.")
        return 1
    except Exception as exc:  # pragma: no cover - unexpected failures
        print(f"Failed to run bandit: {exc}")
        return 1

    try:
        REPORT_PATH.parent.mkdir(parents=True, exist_ok=True)
        REPORT_PATH.write_text(json.dumps(report, indent=2))
    except OSError:
        print("Unable to write report to disk.")
        return 1

    has_critical = any(
        hmac.compare_digest(issue.get("issue_severity", "").upper(), "HIGH")
        for issue in report.get("results", [])
    )
    if has_critical:
        print("Critical vulnerabilities detected.")
        return 1

    print("No critical vulnerabilities found.")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
